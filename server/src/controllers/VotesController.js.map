{"version":3,"sources":["../../../dist/controllers/VotesController.js"],"names":["Object","defineProperty","exports","value","_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","key","Constructor","protoProps","staticProps","prototype","_index","require","_index2","_interopRequireDefault","obj","__esModule","default","_toConsumableArray","arr","Array","isArray","arr2","from","_classCallCheck","instance","TypeError","VotesController","addUpvote","req","res","addVote","addDownvote","valueOfVote","typeOfVote","otherTypeOfVote","message","Votes","findOne","where","UserId","user","userId","RecipeId","params","id","then","vote","destroy","Recipes","findById","recipe","newUpvotesArray","concat","upvotes","filter","update","downvotes","status","jsend","success","slice","catch","error","fail","create"],"mappings":"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","file":"VotesController.js","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nvar _index = require('../models/index');\n\nvar _index2 = _interopRequireDefault(_index);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n/**\r\n * VotesController class\r\n */\nvar VotesController = function () {\n  function VotesController() {\n    _classCallCheck(this, VotesController);\n  }\n\n  _createClass(VotesController, null, [{\n    key: 'addUpvote',\n\n    /**\r\n       * Adds an upvote to a recipe\r\n       * @param {Object} req\r\n       * @param {Object} res\r\n       * @returns {Object} res\r\n       */\n    value: function addUpvote(req, res) {\n      this.addVote(1, 'upvotes', 'downvotes', 'upvoted', req, res);\n    }\n\n    /**\r\n     * Adds a downvote to a recipe\r\n     * @param {Object} req\r\n     * @param {Object} res\r\n     * @returns {Object} res\r\n     */\n\n  }, {\n    key: 'addDownvote',\n    value: function addDownvote(req, res) {\n      this.addVote(0, 'downvotes', 'upvotes', 'downvoted', req, res);\n    }\n\n    /**\r\n     * Method for adding vote\r\n     * Users are allowed to vote more than once, if and only if their previous vote is\r\n     * different from the next one, for example, a user can only upvote once, but a user\r\n     * can downvote after already upvoting, and vice versa\r\n     * @param {Number} valueOfVote\r\n     * @param {String} typeOfVote\r\n     * @param {String} otherTypeOfVote\r\n     * @param {String} message\r\n     * @param {Object} req\r\n     * @param {Object} res\r\n     * @returns {Object} res\r\n     */\n\n  }, {\n    key: 'addVote',\n    value: function addVote(valueOfVote, typeOfVote, otherTypeOfVote, message, req, res) {\n      _index2.default.Votes.findOne({\n        where: {\n          UserId: req.user.userId,\n          RecipeId: req.params.id\n        }\n      }).then(function (vote) {\n        // If user has voted already and the value of the vote\n        // is the same as the requested one, remove the vote\n        if (vote && vote.vote === valueOfVote) {\n          vote.destroy().then(function () {\n            _index2.default.Recipes.findById(req.params.id).then(function (recipe) {\n              if (typeOfVote === 'upvotes') {\n                var newUpvotesArray = [].concat(_toConsumableArray(recipe.upvotes.filter(function (id) {\n                  return id !== req.user.userId;\n                })));\n                recipe.update({\n                  upvotes: newUpvotesArray\n                });\n              } else {\n                recipe.update({\n                  downvotes: [].concat(_toConsumableArray(recipe.downvotes.filter(function (id) {\n                    return id !== req.user.userId;\n                  })))\n                });\n              }\n              return res.status(200).jsend.success({ recipe: recipe, message: 'Your ' + typeOfVote.slice(0, typeOfVote.length - 1) + ' has been cancelled' });\n            });\n          }).catch(function (error) {\n            return res.status(400).jsend.fail(error);\n          });\n        } else if (vote && vote.vote !== valueOfVote) {\n          // If vote is different from previous vote, delete previous vote, and create present one\n          vote.destroy();\n          _index2.default.Votes.create({\n            UserId: req.user.userId,\n            RecipeId: req.params.id,\n            vote: valueOfVote\n          });\n          // Find recipe user voted for, decrement the value of the previous vote, and increment\n          // the present one\n          _index2.default.Recipes.findById(req.params.id).then(function (recipe) {\n            if (typeOfVote === 'upvotes') {\n              recipe.update({\n                upvotes: [].concat(_toConsumableArray(recipe.upvotes), [req.user.userId])\n              }).then(function () {\n                recipe.update({\n                  downvotes: [].concat(_toConsumableArray(recipe.downvotes.filter(function (id) {\n                    return id !== req.user.userId;\n                  })))\n                }).then(function () {\n                  return res.status(200).jsend.success({ recipe: recipe, message: 'Recipe ' + message });\n                }).catch(function (error) {\n                  return res.status(400).jsend.error(error);\n                });\n              });\n            } else {\n              recipe.update({\n                downvotes: [].concat(_toConsumableArray(recipe.downvotes), [req.user.userId])\n              }).then(function () {\n                recipe.update({\n                  upvotes: [].concat(_toConsumableArray(recipe.upvotes.filter(function (id) {\n                    return id !== req.user.userId;\n                  })))\n                }).then(function () {\n                  return res.status(200).jsend.success({ recipe: recipe, message: 'Recipe ' + message });\n                }).catch(function (error) {\n                  return res.status(400).jsend.error(error);\n                });\n              });\n            }\n          }).catch(function (error) {\n            return res.status(400).jsend.error(error);\n          });\n        } else {\n          // If user has not voted at all, then create the vote\n          _index2.default.Votes.create({\n            UserId: req.user.userId,\n            RecipeId: req.params.id,\n            vote: valueOfVote\n          }).then(function () {\n            _index2.default.Recipes.findById(req.params.id).then(function (recipe) {\n              if (typeOfVote === 'upvotes') {\n                recipe.update({\n                  upvotes: [].concat(_toConsumableArray(recipe.upvotes), [req.user.userId])\n                }).then(res.status(200).jsend.success({ recipe: recipe, message: 'Recipe ' + message })).catch(function (error) {\n                  return res.status(400).jsend.error(error);\n                });\n              } else {\n                recipe.update({\n                  downvotes: [].concat(_toConsumableArray(recipe.downvotes), [req.user.userId])\n                }).then(res.status(200).jsend.success({ recipe: recipe, message: 'Recipe ' + message })).catch(function (error) {\n                  return res.status(400).jsend.error(error);\n                });\n              }\n            });\n          }).catch(function (error) {\n            return res.status(400).jsend.error(error);\n          });\n        }\n      }).catch(function (error) {\n        return res.status(400).jsend.error(error);\n      });\n    }\n  }]);\n\n  return VotesController;\n}();\n\nexports.default = VotesController;"]}